<?xml version="1.0" encoding="UTF-8"?>
<!-- This template is for creating an Internet Draft using xml2rfc,
     which is available here: http://xml.resource.org. -->
<!DOCTYPE rfc SYSTEM "rfc2629.dtd" [
<!ENTITY RFC1034 SYSTEM "https://xml2rfc.tools.ietf.org/public/rfc/bibxml/reference.RFC.1034.xml">
<!ENTITY RFC1035 SYSTEM "https://xml2rfc.tools.ietf.org/public/rfc/bibxml/reference.RFC.1035.xml">
<!ENTITY RFC6891 SYSTEM "https://xml2rfc.tools.ietf.org/public/rfc/bibxml/reference.RFC.6891.xml">

<!ENTITY nbsp    "&#160;">
]>

<rfc category="info" docName="draft-sonoda-lb-rr-00">
  <front>
    <title abbrev="Abbreviated Title">LB DNS Resource Record</title>

    <author fullname="Manabu Sonoda" role="editor" surname="Sonoda">
      <organization>Internet Initiative Japan Inc.</organization>
      <address>
        <email>manbabu-s@iij.ad.jp</email>
      </address>
    </author>

    <date month="Jan" year="2018" />

    <!-- Meta-data Declarations -->

    <area>General</area>

    <workgroup>Domain Name System Operations</workgroup>
    <keyword>DNS</keyword>
    <abstract>
      <t>This document defines a new DNS Resource Record called "DNAME", which
   provides the balancing function for A and AAAA Recourds indirectly.</t>
      <t>本文書は「LB」という新しいリソースレコードを定義する。LBは、A,AAAAのバランシング機能を提供する。</t>
    </abstract>
  </front>

  <middle>
    <section title="Introduction">
      <t>This document defines a new DNS Resource Record called "DNAME", which
      provides the weight base balancing and network location base balancing for A, AAAA records
      Using redirect name.
      </t>
     <t>
      LBは、重み付けベースと、ネットワークロケーションベースのバランシング機能を別名へのリダイレクトと共に提供する。
     </t>
    </section>
    <section title='Motivation'>
      <t>
        現在のDNSの仕様では、A,AAAA RRはアドレス情報のみを持っており、その利用に際しアドレスごとの重み付けをすることは困難である。
        現在多く行われている手法は、非標準の方法として、Authoritative Server側で、重み付けを考慮して選択した一つのRRを返す手法である。
        これは、非標準の方法であるため、ゾーン転送機能によって重み付け情報をセカンダリサーバへ転送することができない。
        また、DNSSECの観点からもOnline署名が必要になってくるため、全てのセカンダリサーバで署名鍵を持つ必要があるなど、現実的ではない。

        また、実際のRRを利用するクライアントのネットワーク的な位置により、利用させたいRRを変更したいレコードも存在する。。
        重み付け同様に、現在のDNSの仕様では、A,AAAAにネットワーク的な位置情報を含めることはできない。
        現在多く行われている手法は、非標準の方法として、問い合わせを行うクライアントのIPアドレスを元に、Authoritative Server側が
        A, AAAAレコード応答を変える手法である。
        A,AAAAとネットワーク的な位置情報のマッピングはゾーン外の機能として実装されている為、セカンダリサーバに転送することができない。

        これらの問題点を解決する為、特殊なレコードとしてLBレコードを定義する。
        このレコードを使用すれば、DNS Provider実装に依存しないGlobal Load BalancingとLocal Balancingが提供できるようになり。
        複数のDNS Providerを利用したゾーンの運用が行いやすくなる。
      </t>
    </section>

    <section title="The LB Resource Record">
      <t>The DNAME RR has mnemonic LB.</t>
      <t>LB format below.</t>
      <figure><artwork><![CDATA[
      <owner> <ttl> <class> LB <rrtype> <weight> <geocode> <target>
      ]]></artwork></figure>
      <t>The format is not class-sensitive.  All fields are required. 。</t>
      <t>&lt;rrtype&gt; field is a 2 octets, A or AAAA RRType.</t>
      <t>&lt;weight&gt; field is a 2 octets, 1 or more natural number.</t>
      <t>&lt;geocode&gt; field is a 2 octets, natural number ISO 3166-1 alpha-2 Country code or Continental code that AF,AN,AS,EU,NA,OC and SA or "0" meen all countries.</t>
      <t>&lt;target&gt; field is a &lt;domain-name&gt; <xref target="RFC1035"/></t>
      <t>Record example:</t>
      <figure><artwork><![CDATA[
      example.jp. 3600 IN LB A 1 0 www.example.com. ; for not AP region
      example.jp. 3600 IN LB A 1 AP ap.example.com. ; for AP region exclude JP
      example.jp. 3600 IN LB A 1 JP jp1.example.jp. ; for JP region
      example.jp. 3600 IN LB A 3 JP jp2.example.jp. ; for JP region
      ]]></artwork></figure>
    </section>

    <section title="Full Service Resolver Behavior">
      <t>1. Full resolver recived A or AAAA query from stub resolver</t>
      <t>1. スタブリゾルバからA,AAAAのクエリーを受け取る</t>
      <t>2. If Full resolver support LB RR, Full resolver doing special action before step 5.3.1 1<xref target='RFC1034'></t>
      <t>2.1. If a match QNAME and local LB RRset node name, and LB RRset include LB that's rrtype is QTYPE then 
        copy all LB RRSet into the answer section and goto 3, else STYPE=LBにして、goto step 5.3.1 2<xref target='RFC1034'></t></t>  
      <t>2.2. ResolverがLB RRに対応している場合、クエリーA,AAAAの代わりにLBの問い合わせを行う。</t>
      <t>qtype=レスポンスとして、ANSWER SECTIONにLB RRSetが含まれている場合特別の動作を行う。</t>
      <t>3.1 DNSSEC署名されている場合は、LB RRSetに対して、署名検証を行う。失敗（Bogus)の場合はスタブリゾルバに
          SERVFAILを返し処理を終了する。</t>
      <t>LB RRSetから、qtype = &lt;rrtype&gt;であるLB RRを選択する。</t>
      <t>&lt;geocode&gt;が0でない場合は、&lt;geocode&gt;を使用して、さらにLB RRを絞り込む。</t>
      <t>（実装依存だが、リゾルバ自身に設定された、ネットワーク的な位置情報で絞り込むことを想定、またスタブリゾルバのIPをGeoIP Databaseを用いて位置情報を割り出し
        それに基づいて絞り込むことも可能）</t>
      <t>この時点で、選択できるLB RRがない場合は通常のA,AAAAの名前解決処理を行う</t>
      <t>qtype = &lt;rrtype&gt;であるLB RRが複数ある場合は、&lt;weight&gt;に従って、レスポンスとして返す&lt;target&gt;を選択する。
          &lt;weight&gt;は値が大きい方が優先で、比率によって、選択する&lt;target&gt;を変化させるのを期待する。</t>
      <t>選択した&lt;target&gt;をqname、&lt;rrtype&gt;をqtypeとして、”名前解決”する。名前解決の結果、qtypeが一致するRRSetが
          得られない場合、5に戻って別の&lt;target&gt;を選択する。全ての&lt;target&gt;で失敗した場合は8に飛ぶ。</t>
      <t>ターゲットを名前解決した結果を署名検証する。失敗（Bogus)の場合は、5に戻って別の&lt;target&gt;を選択する。
          全ての&lt;target&gt;で失敗した場合は8に飛ぶ。</t>
      <t>スタブリゾルバの応答として、LB RRsetをANSWER SECTIONに追加する。ターゲットを名前解決の結果、
          qtypeが一致するRRが得らた場合は、その名前解決の結果をANSWER SECTIONに追加する。また、LB RRSETと
        ターゲットが共に署名検証に成功していればAD BITを付ける。</t>
      <section title="Example of Full Service Resolver Behavior">
        <t>If response include LB:</t>
        <figure><artwork><![CDATA[
    query: qtype = example.jp. qtype=LB
    response:
      answer:
            example.jp. 3600 IN LB A 1 0 www.example.com.
            example.jp. 3600 IN LB A 1 JP jp1.example.com.
            example.jp. 3600 IN LB A 3 JP jp2.example.com.
            example.jp. 3600 IN LB AAAA 1 JP jp1.example.com.
            example.jp. 3600 IN LB AAAA 3 JP jp2.example.com.
      authority:
            example.jp. 3600 IN NS ns1.example.com.
            example.jp. 3600 IN NS ns2.example.com.
              ]]></artwork></figure>
        <t>Select LB RR that's rrdtype is A:</t>
        <figure><artwork><![CDATA[
    example.jp. 3600 IN LB A 1 0 www.example.com.
    example.jp. 3600 IN LB A 1 JP jp1.example.com.
    example.jp. 3600 IN LB A 3 JP jp2.example.com.
              ]]></artwork></figure>
        <t>select LB RR that's geocode include resolver location"</t>
        <t>If resolver location is JP then select RR are 2 RR: </t>
        <figure><artwork><![CDATA[
    example.jp. 3600 IN LB A 1 JP jp1.example.com.
    example.jp. 3600 IN LB A 3 JP jp2.example.com.
              ]]></artwork></figure>
        <t>Select one LB RR using &lt;weight&gt;:</t>
        <figure><artwork><![CDATA[
    example.jp. 3600 IN LB A 3 JP jp2.example.com.
              ]]></artwork></figure>
        <t>Name resolution &lt;target&gt;:</t>
        <figure><artwork><![CDATA[
    query: qtype = jp2.example.com. qtype=A
    response:
      answer:
            jp2.example.com. 3600 IN A 192.0.2.2
      authority:
            example.com. 3600 IN NS ns1.example.com.
            example.com. 3600 IN NS ns2.example.com.
        ]]></artwork></figure>
        <t>Make response message:</t>
        <figure><artwork><![CDATA[
    query: qtype = example.jp. qtype=A
    response:
      answer:
            example.jp. 3600 IN LB A 1 0 www.example.com.
            example.jp. 3600 IN LB A 1 JP jp1.example.com.
            example.jp. 3600 IN LB A 3 JP jp2.example.com.
            example.jp. 3600 IN LB AAAA 1 JP jp1.example.com.
            example.jp. 3600 IN LB AAAA 3 JP jp2.example.com.
            jp2.example.com. 3600 IN A 192.0.2.2
      authority:
            example.jp. 3600 IN NS ns1.example.com.
            example.jp. 3600 IN NS ns2.example.com.
        ]]></artwork></figure>
        <t>Stub resolver uses 192.0.2.2</t>
      </section>
    </section>

    <section title="IANA Considerations">
      <t>IANA is requested to assign a DNS RR data type value for the LB RR type under 
         the "Resource Record (RR) TYPEs" subregistry 
         under the "Domain Name System (DNS) Parameters" registry.</t>
    </section>

    <section title="Security Considerations">
      <t>リゾルバでは、LBの&lt;target&gt;のレスポンスとして、LB,CNAME,DNAMEが返ってくることもある。その場合、多段で名前解決を行うことになるため、limitを描けるなどloopしないように注意する必要がある。</t>
    </section>

  </middle>

  <!--  *****BACK MATTER ***** -->

  <back>
    <references title='Normative References'>
&RFC1034;
&RFC1035;
&RFC6891;
    </references>
  </back>
</rfc>

