<?xml version="1.0" encoding="UTF-8"?>
<!-- This template is for creating an Internet Draft using xml2rfc,
     which is available here: http://xml.resource.org. -->
<!DOCTYPE rfc SYSTEM "rfc2629.dtd" [
<!ENTITY RFC1034 SYSTEM "https://xml2rfc.tools.ietf.org/public/rfc/bibxml/reference.RFC.1034.xml">
<!ENTITY RFC1035 SYSTEM "https://xml2rfc.tools.ietf.org/public/rfc/bibxml/reference.RFC.1035.xml">
<!ENTITY RFC6891 SYSTEM "https://xml2rfc.tools.ietf.org/public/rfc/bibxml/reference.RFC.6891.xml">

<!ENTITY nbsp    "&#160;">
]>

<rfc category="info" docName="draft-sonoda-lb-rr-00">
  <front>
    <title abbrev="Abbreviated Title">DNS load balance</title>

    <author fullname="Manabu Sonoda" role="editor" surname="Sonoda">
      <organization>Internet Initiative Japan Inc.</organization>
      <address>
        <email>manbabu-s@iij.ad.jp</email>
      </address>
    </author>

    <date month="Jan" year="2018" />

    <!-- Meta-data Declarations -->

    <area>General</area>

    <workgroup>Domain Name System Operations</workgroup>
    <keyword>DNS</keyword>
    <abstract>
      <t>This document defines a new DNS base load balance function.</t>
    </abstract>
  </front>

  <middle>
    <section title="Introduction and Background">
      <t> This document defines a new DNS load balance function that is able to transfer information in zone transfer and not need online signing.</t>
      <t>DNS base load balance is popluer technology. It provides weight base response and location base response.
      It have become an indispensable part of traffic engineering.
      </t>
      <t>However, DNS base load balance can't transfer load balance information in zone transfer and need online sigining because it is not standardized.</t>

      <t> This document defines a new DNS resource record called "LB" and new EDNS option bit called "LS".
        LB RR provides the balancing function for A and AAAA Recourds indirectly.
        LS bit provides the change response mechanism in name servers.</t>
    </section>

    <section title="The LB Resource Record">
      <t>The LB RR has mnemonic LB. LB RR define load balance information.</t>
      <t>LB format below.</t>
      <figure><artwork><![CDATA[
      <owner> <ttl> <class> LB <weight> <location> <target>
            ]]></artwork></figure>
      <t>The format is not class-sensitive.  All fields are required. 。</t>
      <t>&lt;weight&gt; field is a 2 octets, 1 or more natural number.</t>
      <t>&lt;location&gt; field is a &lt;character-string&gt;  <xref target="RFC1035"/></t>. &lt;location&gt; field has 4 types.</t>
      <t>1. ISO 3166-2 Codes for the representation of names of countries and their subdivisions.</t>
      <t>2. ISO 3166-1 alpha-2 Country code</t>
      <t>3. Continental code that AF,AN,AS,EU,NA,OC and SA</t> 
      <t>4. "*" meen any region.</t>
      <t>&lt;target&gt; field is a &lt;domain-name&gt; <xref target="RFC1035"/>. &lt;target&gt; name has A or AAAA RR or CNAME RR or DNAME RR.</t>
      <t>Record example:</t>
      <figure><artwork><![CDATA[
      example.jp. 3600 IN LB 1 * www.example.com. ; for any region.
      example.jp. 3600 IN LB 1 AP ap.example.com. ; for AP region.
      example.jp. 3600 IN LB 1 JP jp1.example.jp. ; for JP region, weight 1.
      example.jp. 3600 IN LB 3 JP jp2.example.jp. ; for JP region, weight 3.
      example.jp. 3600 IN LB 1 JP-13 tokyo.example.jp. ; for tokyo region. (JP-13 is tokyo region ISO 3166-2:JP)
      ]]></artwork></figure>      
    </section>

    <section title="The LB Support Flag">
      <t>Defines a new EDNS Header Flags <xref target='RFC6891' /> call LB Support Flag(LS) using full resolver sends LB RR supported to authoritative server.</t>
      <t>LS bit provides change response mechanism in authoritative name server. If LS bit is flagged, Authoritative name server can response LB RR for A,AAAA query.</t>
    </section>

    <section title="Authoritative name server Behavior">
      <t>1. If request query on EDNS Header LS bit then Authoritative name server special action before 4.3.2 3.a. <xref target='RFC1034' /> </t>
      <t>2. If QTYPE is A or B and a match between QNAME and LB RRset node name then 
         copy all LB RRSet into the answer section and go to step 6 <xref target='RFC1034' /> . else go to step 4.2.3 3.a. </t>
      <t>3. If request query on EDNS Header LS bit then Authoritative name server SHOULD flagge LS bit in reply message.</t>
      <section title="Example of authoritative name server behavior">
        <t>Example zone data:</t>
        <figure><artwork><![CDATA[
    example.jp. 3600 IN SOA ns1.example.com. postmaster.example.com. 100 3600 900 1814400 900
    example.jp. 3600 IN NS ns1.example.com.
    example.jp. 3600 IN NS ns2.example.com.
    example.jp. 3600 IN A 198.51.100.1
    example.jp. 3600 IN LB 1 * www.example.com.
    example.jp. 3600 IN LB 1 JP jp1.example.com.
    example.jp. 3600 IN LB 3 JP jp2.example.com.
              ]]></artwork></figure>
        <t>Incomming query with LS bit:</t>
        <figure><artwork><![CDATA[
    query: qtype = example.jp. qtype=A, LS=1
      ]]></artwork></figure>
        <t>Response for include LS:</t>
        <figure><artwork><![CDATA[
    query: qtype = example.jp. qtype=A
    response: LS=1
      answer:
        example.jp. 3600 IN LB 1 * www.example.com.
        example.jp. 3600 IN LB 1 JP jp1.example.com.
        example.jp. 3600 IN LB 3 JP jp2.example.com.
      authority:
        example.jp. 3600 IN NS ns1.example.com.
        example.jp. 3600 IN NS ns2.example.com.
      ]]></artwork></figure>
        <t>Incomming query without LS bit (normal query):</t>
        <figure><artwork><![CDATA[
    query: qtype = example.jp. qtype=A, LS=0
      ]]></artwork></figure>
        <t>Response for not include LS:</t>
        <figure><artwork><![CDATA[
    query: qtype = example.jp. qtype=A
    response:  LS=0
      answer:
            example.jp. 3600 IN A 198.51.100.1
      authority:
            example.jp. 3600 IN NS ns1.example.com.
            example.jp. 3600 IN NS ns2.example.com.
              ]]></artwork></figure>
      </section>
    </section>


    <section title="Full Service Resolver Behavior">
      <t>1. If Full resolver support LB RR, Full resolver send query to Authoritative Server with LS BIT.</t>
      <t>2. If the responses shows a LB and that is now the answer itself, goto step 2.1 before 5.3.3 4<xref target='RFC1034' /> else step 5.3.3 4<xref target='RFC1034'</t>
      <t>3. Select the target name from LB RR using weight and location.</t>
      <t>3.1. First step, Exclude RR that's same value OWNER and target name.</t>
      <t>3.2. Second step is location selection. location Selection needs location information. Full Resolver default location is '*'. Location Information SHOULD gets from full resolver config. MAY resolv location using stub resolver IP and GeoIP database.
             The width of location decreases in order of　ANY,　Continental code, Country code. MUST select small area.
             If RRSet not include RR that's  location is '*', Mayby can't select RR code. The case, Resolver stop algorithm and return response or Resolver MAY requery without LS bit.
      <t>3.3. Third step is weight selection.  </t>
      <t>A Selection result MAY be cached.</t>
      <section title="Example of Full Service Resolver Behavior">
        <t>1. Full resolver's location is configured "JP-13 JP AS *".</t>
        <t>2. Stub resolver query comming:</t>
        <figure><artwork><![CDATA[
    query: qtype = example.jp. qtype=A
              ]]></artwork></figure>
        <t>3. Full resolver send query:</t>
        <figure><artwork><![CDATA[
    query: qtype = example.jp. qtype=A, LS=1
              ]]></artwork></figure>
        <t>3. If response include LB:</t>
        <figure><artwork><![CDATA[
    query: qtype = example.jp. qtype=A
    response: LS=1
      answer:
            example.jp. 3600 IN LB 1 * www.example.com.
            example.jp. 3600 IN LB 1 JP jp1.example.com.
            example.jp. 3600 IN LB 3 JP jp2.example.com.
      authority:
            example.jp. 3600 IN NS ns1.example.com.
            example.jp. 3600 IN NS ns2.example.com.
              ]]></artwork></figure>
        <t>4. select LB RR that's location include resolver location</t>
        <figure><artwork><![CDATA[
            example.jp. 3600 IN LB 1 JP jp1.example.com.
            example.jp. 3600 IN LB 3 JP jp2.example.com.
              ]]></artwork></figure>
        <t>5. Select one LB RR using &lt;weight&gt;:</t>
        <figure><artwork><![CDATA[
            example.jp. 3600 IN LB 3 JP jp2.example.com.
              ]]></artwork></figure>
        <t>5. Name resolution &lt;target&gt;:</t>
        <figure><artwork><![CDATA[
    query: qtype = jp2.example.com. qtype=A, LS=1
    response:
      answer:
            jp2.example.com. 3600 IN A 192.0.2.2
      authority:
            example.com. 3600 IN NS ns1.example.com.
            example.com. 3600 IN NS ns2.example.com.
        ]]></artwork></figure>
        <t>6. Make response message:</t>
        <figure><artwork><![CDATA[
    query: qtype = example.jp. qtype=A, LS=1
    response:
      answer:
            example.jp. 3600 IN LB 1 * www.example.com.
            example.jp. 3600 IN LB 1 JP jp1.example.com.
            example.jp. 3600 IN LB 3 JP jp2.example.com.
            jp2.example.com. 3600 IN A 192.0.2.2
      authority:
            example.jp. 3600 IN NS ns1.example.com.
            example.jp. 3600 IN NS ns2.example.com.
        ]]></artwork></figure>
        <t>7. Stub resolver uses 192.0.2.2</t>
      </section>
    </section>

    <section title="IANA Considerations">
      <t>IANA is requested to assign a DNS RR data type value for the LB RR type under 
         the "Resource Record (RR) TYPEs" subregistry and
         a EDNS Header Flag value fro the LB Support Flag under 
         the "EDNS Header Flags (16 bits)" subregistry
         under the "Domain Name System (DNS) Parameters" registry.</t>
    </section>

    <section title="Security Considerations">
      <t>リゾルバでは、LBの&lt;target&gt;のレスポンスとして、LB,CNAME,DNAMEが返ってくることもある。その場合、多段で名前解決を行うことになるため、limitを描けるなどloopしないように注意する必要がある。</t>
    </section>

  </middle>

  <!--  *****BACK MATTER ***** -->

  <back>
    <references title='Normative References'>
&RFC1034;
&RFC1035;
&RFC6891;
    </references>
  </back>
</rfc>

