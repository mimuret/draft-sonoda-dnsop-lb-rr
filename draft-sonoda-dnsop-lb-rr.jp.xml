<?xml version="1.0" encoding="UTF-8"?>
<!-- This template is for creating an Internet Draft using xml2rfc,
     which is available here: http://xml.resource.org. -->
<!DOCTYPE rfc SYSTEM "rfc2629.dtd" [
<!-- A set of on-line citation libraries are maintained on the xml2rfc web site.
     The next line defines an entity named RFC2629, which contains the necessary XML
     for the reference element, and is used much later in the file.  This XML contains an
     anchor (also RFC2629) which can be used to cross-reference this item in the text.
     You can also use local file names instead of a URI.  The environment variable
     XML_LIBRARY provides a search path of directories to look at to locate a 
     relative path name for the file. There has to be one entity for each item to be
     referenced. -->
<!ENTITY RFC2234 SYSTEM "http://xml.resource.org/public/rfc/bibxml/reference.RFC.2234.xml">
<!ENTITY RFC2629 SYSTEM "http://xml.resource.org/public/rfc/bibxml/reference.RFC.2629.xml">
<!ENTITY RFC4234 SYSTEM "http://xml.resource.org/public/rfc/bibxml/reference.RFC.4234.xml">
<!-- There is also a library of current Internet Draft citations.  It isn't a good idea to
     actually use one for the template because it might have disappeared when you come to test 
     this template.  This is the form of the entity definition
     &lt;!ENTITY I-D.mrose-writing-rfcs SYSTEM 
     "http://xml.resource.org/public/rfc/bibxml3/reference.I-D.mrose-writing-rfcs.xml">
     corresponding to a draft filename draft-mrose-writing-rfcs-nn.txt. The citation will be
     to the most recent draft in the sequence, and is updated roughly hourly on the web site.
     For working group drafts, the same principle applies: file name starts draft-ietf-wgname-..
     and entity file is reference.I-D.ietf-wgname-...  The corresponding entity name is 
     I-D.ietf-wgname-... (I-D.mrose-writing-rfcs for the other example).  Of course this doesn't
     change when the draft version changes.
     -->
<!-- Fudge for XMLmind which doesn't have this built in -->
<!ENTITY nbsp    "&#160;">
]>

<rfc category="info" docName="draft-sonoda-lb-rr-00">
  <front>
    <title abbrev="Abbreviated Title">Redirect RR</title>

    <author fullname="Manabu Sonoda" role="editor" surname="Sonoda">
      <organization>Internet Initiative Japan Inc.</organization>
      <address>
        <email>manbabu-s@iij.ad.jp</email>
      </address>
    </author>

    <date month="Jan" year="2018" />

    <!-- Meta-data Declarations -->

    <area>General</area>

    <workgroup>Domain Name System Operations</workgroup>
    <keyword>DNS</keyword>
    <abstract>
      <t>本文書は「LB」という新しいリソースレコードを定義する。LBは、A,AAAAのバランシング機能を提供する。</t>
    </abstract>
  </front>

  <middle>
    <section title="Introduction">
      <t>
        本文書は「LB」という新しいリソースレコードを定義する。
        LBは、A,AAAAのバランシング機能を別ドメイン名へのリダイレクトと共に提供する。
        現在のDNSの仕様では、A,AAAA RRはアドレス情報のみを持っており、IPアドレスごとに重み付けをすることは困難である。
        現在多く行われている手法は、非標準の方法として、Authoritative Server側で、重み付けを考慮して選択した1レコードのみを返す手法である。
        これは、非標準であるため、ゾーン転送機能によって重み付けをセカンダリサーバへ転送することができない。
        また、DNSSEC署名の観点からもOnline署名が必要になってくるため、全てのセカンダリサーバで署名鍵を持つ必要がある。

      </t>
    </section>

    <section title="LoadBalance Resource Record">
      <t>LBリソースレコードのニーモニックはLBである。</t>
      <t>LBの書式を示す</t>
        <artwork align="left"><![CDATA[
                <owner> <ttl> <class> LB <rrtype> <weight> <target>
            ]]></artwork>
      <t>この書式には、クラスの区別はなく、全てが必須フィールドである。</t>
      <t>RDATAの各要素は、&lt;rrtype&gt;はTYPE [RFC1035]、&lt;weight&gt;2 octetsの1以上の整数値、&lt;target&gt;は &lt;domain-name&gt; [RFC1035]である。</t>
      <t>&lt;rrtype&gt;として、指定できるのは、A・AAAAである。</t>
    </section>
    <section title="EDNS LB Support">
                <t>Full resolverが、権威DNSに対して、LBをサポートしている事を伝える為、EDNS LB Supportを定義する（ELS)</t>
        <t>ERS Format</t>
        <artwork align="left"><![CDATA[
                +0 (MSB)                            +1 (LSB)
      +---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+
   0: |                          OPTION-CODE                          |
      +---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+
   2: |                         OPTION-LENGTH = 0                     |
      +---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+

                ]]></artwork>
                <t>OPTION-CODE, 2 octets</t>
                <t>OPTION-CODE, 2 octets, need 0</t>
    </section>

    <section title="Authoritative Server Behavior">
      <t>Authoritative Serverに問い合わせたクエリーの中にELSが含まれている場合に以下の特別の動作を行う。</t>
      <t>qnameが一致するLBが存在し、qtype = rrtype である LB が存在する場合は、ANSWER SECTIONとして、LB RRSETを追加する。
         この際、そのLBのtarget、rrtypeが一致するRRがある場合でも、ANSWER SECTIONに追加してはならない。
         また、qname、qtypeに一致するRRがある場合もANSWER SECTIONに追加してはならない。
         DNSSEC署名がされている場合は、LBに対するRRSIGを返す
      </t>
    </section>

    <section title="Full Service Resolver Behavior">
      <t>1. スタブリゾルバからA,AAAAのクエリーを受け取る</t>
      <t>2. ResolverがLB RRに対応している場合、クエリーにELSを付加して問い合わせを行う。</t>
      <t>3. qtype=A,AAAAのレスポンスとして、ANSWER SECTIONにLB RRSetが含まれている場合特別の動作を行う。</t>
      <t>4. DNSSEC署名されている場合は、LB RRSetに対して、署名検証を行う。失敗（Bogus)の場合はスタブリゾルバにSERVFAILを返し処理を終了する。</t>
      <t>5. LB RRSetから、qtype = rrtypeであるLB RRを選択する。</t>
      <t>6. qtype = rrtypeであるLB RRが複数ある場合は、weightに従って、レスポンスとして返すtargetを選択する。weightは値が大きい方が優先で、比率によって、選択するtargetを変化させるのを期待する。</t>
      <t>7. 選択したtargetをqname、rrtypeをqtypeとして、”名前解決”する。名前解決の結果、qtypeが一致するRRSetが得られない場合、5に戻って別のtargetを選択する。全てのtargetで失敗した場合は8に飛ぶ。</t>
      <t>8. ターゲットを名前解決した結果を署名検証する。失敗（Bogus)の場合は、5に戻って別のtargetを選択する。全てのtargetで失敗した場合は8に飛ぶ。</t>
      <t>9. スタブリゾルバの応答として、LB RRsetをANSWER SECTIONに追加する。ターゲットを名前解決の結果、qtypeが一致するRRが得らた場合は、その名前解決の結果をANSWER SECTIONに追加する。
      　　　 また、LB RRSETとターゲットが共に署名検証に成功していればAD BITを付ける。</t>
    </section>

    <section title="IANA Considerations">
      <t>   IANA is requested to assign a DNS RR data type value for the LB RR type under the "Resource Record (RR) TYPEs" subregistry under the "Domain Name System (DNS) Parameters" registry.</t>
    </section>

    <section title="Security Considerations">
      <t>リゾルバでは、LBのtargetのレスポンスとして、LB,CNAME,DNAMEが返ってくることもある。その場合、多段で名前解決を行うことになるため、limitを描けるなどloopしないように注意する必要がある。</t>
    </section>

  </middle>

  <!--  *****BACK MATTER ***** -->

  <back>
    <section anchor="app-additional" title="Additional Stuff">
      <t>This becomes an Appendix.</t>
    </section>
  </back>
</rfc>

