<?xml version="1.0" encoding="UTF-8"?>
<!-- This template is for creating an Internet Draft using xml2rfc,
     which is available here: http://xml.resource.org. -->
<!DOCTYPE rfc SYSTEM "rfc2629.dtd" [
<!ENTITY RFC1034 SYSTEM "https://xml2rfc.tools.ietf.org/public/rfc/bibxml/reference.RFC.1034.xml">
<!ENTITY RFC1035 SYSTEM "https://xml2rfc.tools.ietf.org/public/rfc/bibxml/reference.RFC.1035.xml">
<!ENTITY RFC6891 SYSTEM "https://xml2rfc.tools.ietf.org/public/rfc/bibxml/reference.RFC.6891.xml">

<!ENTITY nbsp    "&#160;">
]>

<rfc category="info" docName="draft-sonoda-lb-rr-00">
  <front>
    <title abbrev="Abbreviated Title">LB DNS Resource Record</title>

    <author fullname="Manabu Sonoda" role="editor" surname="Sonoda">
      <organization>Internet Initiative Japan Inc.</organization>
      <address>
        <email>manbabu-s@iij.ad.jp</email>
      </address>
    </author>

    <date month="Jan" year="2018" />

    <!-- Meta-data Declarations -->

    <area>General</area>

    <workgroup>Domain Name System Operations</workgroup>
    <keyword>DNS</keyword>
    <abstract>
      <t>This document defines a new DNS Resource Record called "LB", which
   provides the balancing function for A and AAAA Recourds indirectly.</t>
      <t>本文書は「LB」という新しいリソースレコードを定義する。LBは、A,AAAAのバランシング機能を提供する。</t>
    </abstract>
  </front>

  <middle>
    <section title="Introduction">
      <t>This document defines a new DNS Resource Record called "LB", which
      provides the weight base balancing and network location base balancing for A, AAAA records
      Using redirect name.
      </t>
     <t>
      LBは、重み付けベースと、ネットワークロケーションベースのバランシング機能を別名へのリダイレクトと共に提供する。
     </t>
    </section>
    <section title='Motivation'>
      <t>
        現在のDNSの仕様では、A,AAAA RRはアドレス情報のみを持っており、その利用に際しアドレスごとの重み付けをすることは困難である。
        現在多く行われている手法は、非標準の方法として、Authoritative Server側で、重み付けを考慮して選択した一つのRRを返す手法である。
        これは、非標準の方法であるため、ゾーン転送機能によって重み付け情報をセカンダリサーバへ転送することができない。
        また、DNSSECの観点からもOnline署名が必要になってくるため、全てのセカンダリサーバで署名鍵を持つ必要があるなど、現実的ではない。

        また、実際のRRを利用するクライアントのネットワーク的な位置により、利用させたいRRを変更したいレコードも存在する。。
        重み付け同様に、現在のDNSの仕様では、A,AAAAにネットワーク的な位置情報を含めることはできない。
        現在多く行われている手法は、非標準の方法として、問い合わせを行うクライアントのIPアドレスを元に、Authoritative Server側が
        A, AAAAレコード応答を変える手法である。
        A,AAAAとネットワーク的な位置情報のマッピングはゾーン外の機能として実装されている為、セカンダリサーバに転送することができない。

        これらの問題点を解決する為、特殊なレコードとしてLBレコードを定義する。
        このレコードを使用すれば、DNS Provider実装に依存しないGlobal Load BalancingとLocal Balancingが提供できるようになり。
        複数のDNS Providerを利用したゾーンの運用が行いやすくなる。
      </t>
    </section>

    <section title="The LB Resource Record">
      <t>The LB RR has mnemonic LB.</t>
      <t>LB string format below.</t>
      <figure><artwork><![CDATA[
      <owner> <ttl> <class> LB <weight> <geocode> <target>
            ]]></artwork></figure>
      <t>The format is not class-sensitive.  All fields are required. 。</t>
      <t>&lt;weight&gt; field is a 2 octets, 1 or more natural number.</t>
      <t>&lt;geocode&gt; field is a &lt;character-string&gt;  <xref target="RFC1035"/></t>, ISO 3166-2 or ISO 3166-1 alpha-2 Country code or Continental code that AF,AN,AS,EU,NA,OC and SA or "*" meen all countries.</t>
      <t>&lt;target&gt; field is a &lt;domain-name&gt; <xref target="RFC1035"/></t>
      <t>Record example:</t>
      <figure><artwork><![CDATA[
      example.jp. 3600 IN LB 1 * www.example.com. ; for world.
      example.jp. 3600 IN LB 1 AP ap.example.com. ; for AP region
      example.jp. 3600 IN LB 1 JP jp1.example.jp. ; for JP region
      example.jp. 3600 IN LB 3 JP jp2.example.jp. ; for JP region
      example.jp. 3600 IN LB 3 JP-13 tokyo.example.jp. ; for tokyo region
      ]]></artwork></figure>
      <t>LB wire format below.</t>
    </section>

    <section title="The LB Support Flag">
      <t>Defines a new EDNS Header Flags <xref target='RFC6891' /> call LB Support Flag(LS) using full resolver sends LB RR supported to authoritative server.</t>
      <t>Full resolverが、権威DNSに対して、LBをサポートしている事を伝える為、EDNS Header Flagsとして、LB Supportを定義する（LS)</t>
    </section>

    <section title="Authoritative Server Behavior">
      <t>1. If request query on EDNS Header LS bit then Authoritative Server special action before 4.3.2 3.a. <xref target='RFC1034' /> </t>
      <t>1. Authoritative Serverに問い合わせたクエリーの中にLSが含まれている場合はstep 4.3.2 3.a <xref target='RFC1034' /> の前に特別の動作を行う。</t>
      <t>2. If QTYPE is A or B and a match between QNAME and LB RRset node name then 
         copy all LB RRSet into the answer section and go to step 6 <xref target='RFC1034' /> . else go to step 4.2.3 3.a. </t>
      <t>2. QTYPEがAもしくはAAAAで、qnameが一致するLBRRsetが存在する場合、ANSWER SECTIONとして、LB RRSETを追加しstep 6 <xref target='RFC1034' />に遷移する。</t>
         そうでない場合は<xref target='RFC1034'> 4.2.3 3a.に遷移する。
      </t>
      <section title="Example of Authoritative Server Behavior">
        <t>Example zone data:</t>
        <figure><artwork><![CDATA[
    example.jp. 3600 IN SOA ns1.example.com. postmaster.example.com. 100 3600 900 1814400 900
    example.jp. 3600 IN NS ns1.example.com.
    example.jp. 3600 IN NS ns2.example.com.
    example.jp. 3600 IN A 198.51.100.1
    example.jp. 3600 IN LB 1 ** www.example.com.
    example.jp. 3600 IN LB 1 JP jp1.example.com.
    example.jp. 3600 IN LB 3 JP jp2.example.com.
              ]]></artwork></figure>
        <t>Response for include LS:</t>
        <figure><artwork><![CDATA[
    query: qtype = example.jp. qtype=A, LS=1
    response:
      answer:
        example.jp. 3600 IN LB 1 0 www.example.com.
        example.jp. 3600 IN LB 1 JP jp1.example.com.
        example.jp. 3600 IN LB 3 JP jp2.example.com.
      authority:
        example.jp. 3600 IN NS ns1.example.com.
        example.jp. 3600 IN NS ns2.example.com.
      ]]></artwork></figure>
        <t>Response for not include LS:</t>
        <figure><artwork><![CDATA[
    query: qtype = example.jp. qtype=A, LS=0
    response:
      answer:
            example.jp. 3600 IN A 198.51.100.1
      authority:
            example.jp. 3600 IN NS ns1.example.com.
            example.jp. 3600 IN NS ns2.example.com.
              ]]></artwork></figure>
      </section>
    </section>


    <section title="Full Service Resolver Behavior">
      <t>1. If Full resolver support LB RR, Full resolver send query to Authoritative Server with LS BIT.</t>
      <t>1. ResolverがLB RRに対応している場合、クエリーにLSを付加して問い合わせを行う。</t>
      <t>2. If the responses shows a LB and that is now the answer itself, goto step 2.1 before 5.3.3 4<xref target='RFC1034' /> else step 5.3.3 4<xref target='RFC1034'</t>
      <t>2. もしレスポンスにLB RRSetが含まれている場合で、LBレコードがqueryに対する答えでない場合は5.3.3 4<xref target='RFC1034' />より前にステップ3へ、それ以外はステップ5.3.3 4<xref target='RFC1034' />に遷移する。</t>
      <t>3. Select the target name from LB RR using weight and geocode.</t>
      <t>3.1. First step, Exclude RR that's same value OWNER and target name.</t>
      <t>3.1. ターゲットの選択は、first stepとしてtargetがRRのnameと等しい場合はloopするため、選択から除外する</t>
      <t>3.2. Second step is geocode selection. Geocode Selection needs location information. Full Resolver default location is '**'. Location Information SHOULD gets from full resolver config. MAY resolv location using stub resolver IP and GeoIP database.
             The width ofgeocode decreases in order of　0,Continental code, Country code. MUST select small area.\
             If RRSet not include RR that's geocode is '**', Mayby can't select RR code. The case stop Resolver Algorithm and return response or 
      <t>3.2. second stepとして、geocodeによる選択を行う。geocodeによる選択には、位置情報が必要であるが、何かしらリゾルバ側で決めたものを使用すれば良い。
            例として、リゾルバの設定として、staticな情報として持っても良し、スタブリゾルバのリクエストIP（もしくはECSからの情報）とGeoIPデータベースを用いて変更しても良い</t>
            geocodeの粒度は0(ALL), Continental code, Country codeの順で小さくなる。なるべく粒度の低いものを選択するべきである。
            geocodeが'**'のレコードがない場合は、選択するRRがない可能性がある。その場合はアルゴリズムを中止し、レスポンスを返すか、You MAY send message exclude LS BIT and go to sstep 5.3.3 1<xref target='RFC1034' /> .</t>
      <t>3.3. Third step is weight selection. per query.</t>
      <t>3.3.　weight　selectionを行う。クエリー毎に、weight値の比率によって、ターゲットの選択を行うことを期待する。</t>
      <section title="Example of Full Service Resolver Behavior">
        <t>If response include LB:</t>
        <figure><artwork><![CDATA[
    query: qtype = example.jp. qtype=A, LS=1
    response:
      answer:
            example.jp. 3600 IN LB 1 ** www.example.com.
            example.jp. 3600 IN LB 1 JP jp1.example.com.
            example.jp. 3600 IN LB 3 JP jp2.example.com.
      authority:
            example.jp. 3600 IN NS ns1.example.com.
            example.jp. 3600 IN NS ns2.example.com.
              ]]></artwork></figure>
        <t>Select LB RR that's rrdtype is A:</t>
        <figure><artwork><![CDATA[
            example.jp. 3600 IN LB 1 ** www.example.com.
            example.jp. 3600 IN LB 1 JP jp1.example.com.
            example.jp. 3600 IN LB 3 JP jp2.example.com.
              ]]></artwork></figure>
        <t>select LB RR that's geocode include resolver location"</t>
        <t>If resolver location is JP then select RR are 2 RR: </t>
        <figure><artwork><![CDATA[
            example.jp. 3600 IN LB 1 JP jp1.example.com.
            example.jp. 3600 IN LB 3 JP jp2.example.com.
              ]]></artwork></figure>
        <t>Select one LB RR using &lt;weight&gt;:</t>
        <figure><artwork><![CDATA[
            example.jp. 3600 IN LB 3 JP jp2.example.com.
              ]]></artwork></figure>
        <t>Name resolution &lt;target&gt;:</t>
        <figure><artwork><![CDATA[
    query: qtype = jp2.example.com. qtype=A, LS=1
    response:
      answer:
            jp2.example.com. 3600 IN A 192.0.2.2
      authority:
            example.com. 3600 IN NS ns1.example.com.
            example.com. 3600 IN NS ns2.example.com.
        ]]></artwork></figure>
        <t>Make response message:</t>
        <figure><artwork><![CDATA[
    query: qtype = example.jp. qtype=A, LS=1
    response:
      answer:
            example.jp. 3600 IN LB 1 ** www.example.com.
            example.jp. 3600 IN LB 1 JP jp1.example.com.
            example.jp. 3600 IN LB 3 JP jp2.example.com.
            jp2.example.com. 3600 IN A 192.0.2.2
      authority:
            example.jp. 3600 IN NS ns1.example.com.
            example.jp. 3600 IN NS ns2.example.com.
        ]]></artwork></figure>
        <t>Stub resolver uses 192.0.2.2</t>
      </section>
    </section>

    <section title="他の提案との違い">
      <t>Authoritative Server側で、ゾーン情報の変更、RRSETの一部応答などは行わない為、DNSSEC署名をセカンダリサーバで行う必要はない。</t>
      <t>LB RRに対応していないAuthoritative Server Behavior, Full Service Resolverの挙動は変わらない、</t>
    </section>
    <section title="IANA Considerations">
      <t>IANA is requested to assign a DNS RR data type value for the LB RR type under 
         the "Resource Record (RR) TYPEs" subregistry and
         a EDNS Header Flag value fro the LB Support Flag under 
         the "EDNS Header Flags (16 bits)" subregistry
         under the "Domain Name System (DNS) Parameters" registry.</t>
    </section>

    <section title="Security Considerations">
      <t>リゾルバでは、LBの&lt;target&gt;のレスポンスとして、LB,CNAME,DNAMEが返ってくることもある。その場合、多段で名前解決を行うことになるため、limitを描けるなどloopしないように注意する必要がある。</t>
    </section>

  </middle>

  <!--  *****BACK MATTER ***** -->

  <back>
    <references title='Normative References'>
&RFC1034;
&RFC1035;
&RFC6891;
    </references>
  </back>
</rfc>

